<!DOCTYPE html>
<head>
  <meta charset="UTF-8" />
  <title>List of all authors</title>
  <style type="text/css">
    body {
      padding: 50px;
    }

    label {
      display: inline-block;
      width: 100px;
    }

    input:read-only {
      background: lightgray;
    }

    .row {
      margin-top: 10px;
    }

    .authors,
    .authors td {
      border: 1px solid lightgray;
      padding: 5px;
    }
  </style>
  <!-- <script src="/webjars/jquery/3.3.1/jquery.min.js"></script> -->
  <script src="scripts/jquery-3.5.1.min.js"></script>
</head>

<body>
  <div class="row">
    <a th:href="@{/books}" href="books.html">Back</a>
  </div>
  <hr />
  <h3>Authors:</h3>

  <table class="authors">
    <thead>
      <tr>
        <th>Name</th>
        <th>Books</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="authorsTable"></tbody>
  </table>

  <!-- Added author -->
  <form id="added-author-form" action="/api/authors">
    <h3>Add author:</h3>

    <div class="row">
      <label for="author-name">Name:</label>
      <input id="author-name" name="name" type="text" value="" />
    </div>

    <div class="row">
      <button id="save-author-button" type="submit">Save</button>
    </div>
  </form>

  <script>
    var restServerUrl = "http://192.168.1.139:8081";
    $(function () {
      updateAuthorTable();
    });

    $("#added-author-form").submit(function (event) {
      event.preventDefault();
      var $form = $(this);
      var data = {};

      $.each(this.elements, function (i, v) {
        var input = $(v);
        data[input.attr("name")] = input.val();
        delete data["undefined"];
      });

      $.ajax({
        url: restServerUrl + $form.attr("action"),
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify(data),
        success: function (result) {
          resetAuthorForm();
          updateAuthorTable();
        },
        error: function (xhr, resp, text) {
          alert(xhr.responseJSON["errors"].toString());
        },
      });
    });

    function resetAuthorForm() {
      $("#authorsTable")[0].innerHTML = "";
      $("#added-author-form")[0].reset();
    }

    function updateAuthorTable() {
      $.get(restServerUrl + "/api/authors").done(function (authors) {
        authors.forEach(function (author) {
          $("tbody").append(`
                          <tr>
                            <td>${author.name}</td>
                            <td>${author.booksTitle}</td>
                            <td>
                              <form
                                method="delete"
                              >
                                <button type="submit">Delete</button>
                              </form>
                            </td>
                          </tr>
                      `);
        });
      });
    }
  </script>
</body>
